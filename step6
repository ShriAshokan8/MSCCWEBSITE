Step 7 – Connect MSC Nexus to Firebase + Firestore for login and full storage

Context:
- Firebase Auth is already being used in the MSC Nexus wrapper for login.
- MSC roles, sharedUid, and dual-email logic are already present.
- MSC Nexus Editor structure (workspaces/folders/files) is being built in /nexus/editor/.
- Now I want ALL data (users, workspaces, folders, files, content, sharing) to be persisted in Firestore.

Very important:
- Use my Firebase config (below).
- Use ES modules, not inline <script> tags.
- Firestore must be the single source of truth for:
  - users
  - workspaces
  - folders
  - pages/documents
  - content
  - sharing rules

Here is my Firebase configuration (you MUST use this):

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyAT3OZyWzxQ9NhL_bwNVes22pCGipiLg2U",
  authDomain: "mscnexus-1.firebaseapp.com",
  projectId: "mscnexus-1",
  storageBucket: "mscnexus-1.firebasestorage.app",
  messagingSenderId: "725398471808",
  appId: "1:725398471808:web:08c2ac317534907a841265",
  measurementId: "G-15CGMZBHDC"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

Your tasks for Step 7:

------------------------------------------------------------
1. Update /nexus/firebase.js to include Firestore
------------------------------------------------------------

In /nexus/firebase.js:

- Keep using ES module imports from the CDN.
- Add Firestore imports and exports.

Example shape (adapt it cleanly):

import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getAnalytics
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  signOut,
  updatePassword
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  collection,
  addDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAT3OZyWzxQ9NhL_bwNVes22pCGipiLg2U",
  authDomain: "mscnexus-1.firebaseapp.com",
  projectId: "mscnexus-1",
  storageBucket: "mscnexus-1.firebasestorage.app",
  messagingSenderId: "725398471808",
  appId: "1:725398471808:web:08c2ac317534907a841265",
  measurementId: "G-15CGMZBHDC"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

export {
  app,
  analytics,
  auth,
  db,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  signOut,
  updatePassword,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  collection,
  addDoc,
  getDocs,
  query,
  where
};

Do NOT use inline <script> tags. Only ES modules.

------------------------------------------------------------
2. Define Firestore collections and document shapes
------------------------------------------------------------

Use these Firestore collections:

- users
- workspaces
- folders
- documents

Document shapes:

users/{sharedUid}:
{
  email: string,
  primaryEmail: string,
  linkedEmails: string[],
  role: string,
  mustChangePassword: boolean,
  sharedUid: string
}

workspaces/{workspaceId}:
{
  name: string,
  createdBy: string,        // sharedUid of creator (e.g. user_shri)
  createdAt: timestamp
}

folders/{folderId}:
{
  name: string,
  workspaceId: string,
  owner: string,            // sharedUid
  sharedWith: string[],     // sharedUid array
  createdAt: timestamp
}

documents/{documentId}:
{
  title: string,
  folderId: string,
  workspaceId: string,
  content: string,          // full document content for now
  owner: string,            // owner sharedUid
  sharedWith: string[],     // extra document-level shares if needed
  createdAt: timestamp,
  updatedAt: timestamp
}

------------------------------------------------------------
3. Connect the editor to Firestore for loading structure
------------------------------------------------------------

In /nexus/editor/editor.js (and/or msc-ui.js):

- Remove hard-coded JSON for MSC structure if you created any in Step 6.
- Instead, fetch everything from Firestore.

Loading logic:
- Load all workspaces for this user:
  - For now, load all documents and folders; later we can filter by role if needed.
- For each workspace:
  - Query folders where workspaceId == that workspace’s id.
- For each folder:
  - Query documents where folderId == folder.id.

Then build the sidebar tree:
- Workspaces
  - Folders under each workspace
    - Documents under each folder

This must use the Firestore db exports from /nexus/firebase.js.

------------------------------------------------------------
4. Connect file/folder creation to Firestore
------------------------------------------------------------

When the user creates:
- A new folder:
  - Add a document to folders collection with owner = currentUser.sharedUid.

- A new document:
  - Add a document to documents collection with:
    - title
    - folderId
    - workspaceId
    - content (initial blank or template)
    - owner = currentUser.sharedUid
    - sharedWith = []

Make sure:
- UI updates after creation by re-querying Firestore or updating state in memory.

------------------------------------------------------------
5. Permissions enforced from Firestore data
------------------------------------------------------------

In the editor permission checks:

A user can edit a document if:
- They are the document.owner
OR
- Their sharedUid is in document.sharedWith
OR
- Their sharedUid is in the folder.sharedWith for that document’s folder
OR
- Their role is Director, DeputyDirector, or StaffCoordinator

Otherwise:
- Show the document in read-only mode.
- Disable save/edit controls.

Make sure:
- These checks use real Firestore data.
- You don’t rely on any local-only mock structure.

------------------------------------------------------------
6. Saving document content to Firestore
------------------------------------------------------------

Implement in editor.js:

- loadDocument(documentId):
  - Reads documents/{documentId} from Firestore.
  - Populates the editor area with document.content.

- saveDocument(documentId, newContent):
  - Checks if the current user has edit permission.
  - If allowed:
    - updateDoc(documents/{documentId}, {
        content: newContent,
        updatedAt: serverTimestamp()
      });

Hook saveDocument:
- To a “Save” button
- Or to Ctrl+S / Cmd+S keybinding
- Only enabled if editing is allowed

------------------------------------------------------------
7. Hook global search into Firestore
------------------------------------------------------------

Update search to work across Firestore data:

- When user types in the search bar:
  - Search across:
    - document title
    - document content
    - folder name
    - workspace name

You can:
- Either fetch documents and filter client-side, or
- Use very simple queries (Firestore is limited for full text)

For now, implement:
- Client-side filtering:
  - Load documents into memory
  - Filter by .title or .content containing the search query (case-insensitive)

Show results:
- As a list (Workspace > Folder > Document)
- Clicking a result opens that document.

------------------------------------------------------------
8. Ensure login and roles are the single entry point
------------------------------------------------------------

All Firestore access in the editor must:
- Assume a user is already logged in via the wrapper (index.html).
- Use the role and sharedUid passed via query parameters.
- Never attempt to log in directly inside the editor.
- Never bypass role or domain checks.

------------------------------------------------------------
9. Commit for Step 7
------------------------------------------------------------

Commit:

- Updated /nexus/firebase.js (with Firestore support)
- Updates to /nexus/editor/editor.js and/or msc-ui.js for:
  - Loading from Firestore
  - Creating folders/documents in Firestore
  - Permission checks based on Firestore
  - Saving edited content back to Firestore
  - Search across Firestore-backed documents

Update the PR description to explain:
- Firestore schema
- How login and roles integrate with saving/loading
- How permissions and sharing now work using Firestore
